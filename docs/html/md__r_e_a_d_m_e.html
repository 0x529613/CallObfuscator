<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cobf: CallObfuscator</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cobf
   </div>
   <div id="projectbrief">PE imports obfuscator</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">CallObfuscator </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Obfuscate (hide) the PE imports from static/dynamic analysis tools. </p>
<h1><a class="anchor" id="autotoc_md1"></a>
Theory</h1>
<p>This's pretty forward, let's say I've used <code>VirtualProtect</code> and I want to obfuscate it with <code>Sleep</code>, the tool will manipulate the IAT so that the thunk that points to <code>VirtualProtect</code> will point instead to <code>Sleep</code>, now at executing the file, windows loader will load <code>Sleep</code> instead of <code>VirtualProtect</code>, and moves the execution to the entry point, from there the execution will be redirected to the shellcode, the tool put before, to find the address of <code>VirtualProtect</code> and use it to replace the address of <code>Sleep</code> which assigned before by the loader. </p>
<h1><a class="anchor" id="autotoc_md2"></a>
How to use</h1>
<ul>
<li>It can be included directly as a library, see the following snippet (based on the example), also you can take a look at <a href="cli/cli.cpp">cli.cpp</a>. <div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;cobf.hpp&gt;</div>
<div class="line"> </div>
<div class="line">int main() {</div>
<div class="line">    cobf obf_file = cobf(&quot;sample.exe&quot;);</div>
<div class="line">    obf_file.load_pe();</div>
<div class="line">    obf_file.obf_sym(&quot;kernel32.dll&quot;, &quot;SetLastError&quot;, &quot;Beep&quot;);</div>
<div class="line">    obf_file.obf_sym(&quot;kernel32.dll&quot;, &quot;GetLastError&quot;, &quot;GetACP&quot;);</div>
<div class="line">    obf_file.generate(&quot;sample_obfuscated.exe&quot;);</div>
<div class="line">    obf_file.unload_pe();</div>
<div class="line">    return 0;</div>
<div class="line">};</div>
</div><!-- fragment --></li>
<li>Also can be used as a command line tool by supplying it with the input PE path, the output PE path and optionally the path to the configuration file (default is <code>config.ini</code>). <code>cobf.exe &lt;input file&gt; &lt;out file&gt; [config file]</code> The config file contains the obfuscations needed (dlls, symbols, ...). Here is a template for the config file content <div class="fragment"><div class="line">; Template for the config file:</div>
<div class="line">;   * Sections can be written as:</div>
<div class="line">;       [dll_name]</div>
<div class="line">;       old_sym=new_sym</div>
<div class="line">;   * The dll name is case insensitive, but </div>
<div class="line">;   the old and the new symbols are not.</div>
<div class="line">;   * You can use the wildcard on both the</div>
<div class="line">;   dll name and the old symbol.</div>
<div class="line">;   * You can use &#39;#&#39; at the start of</div>
<div class="line">;   the old or the new symbol to flag </div>
<div class="line">;   an ordinal.</div>
<div class="line">;   * The new symbol should be exported</div>
<div class="line">;   by the dll so the windows loader can resolve it.</div>
<div class="line">; For example:</div>
<div class="line">;   * Obfuscating all of the symbols</div>
<div class="line">;   imported from user32.dll with ordinal 1600.</div>
<div class="line">[user32.dll]</div>
<div class="line">*=#1600</div>
<div class="line">;   * Obfuscating symbols imported from both</div>
<div class="line">;   kernel32.dll and kernelbase.dll with Sleep.</div>
<div class="line">[kernel*.dll]</div>
<div class="line">*=Sleep</div>
<div class="line">;   * Obfuscating fprintf with exit.</div>
<div class="line">[*]</div>
<div class="line">fprintf=exit</div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Example</h1>
<p>Build this code sample </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;windows.h&gt;</div>
<div class="line">#include &lt;stdio.h&gt;</div>
<div class="line"> </div>
<div class="line">int main() {</div>
<div class="line">    SetLastError(5);</div>
<div class="line">    printf(&quot;Last error is %d\n&quot;, GetLastError());</div>
<div class="line">    return 0;</div>
<div class="line">};</div>
</div><!-- fragment --><p>After building it, this is how the kernel32 imports look like</p>
<p><img src="Images/pic1.png" alt="pic1" class="inline"/></p>
<p>Now let's obfuscate both <code>SetLastError</code> and <code>GetLastError</code> with <code>Beep</code> and <code>GetACP</code> (actually any api from kernel32 will be ok even if it's not imported at all). The used configurations are </p><div class="fragment"><div class="line">[kernel32.dll]</div>
<div class="line">SetLastError=Beep</div>
<div class="line">GetLastError=GetACP</div>
</div><!-- fragment --><p>Here is the output (also you can use the library directly as shown above).</p>
<p><img src="Images/pic2.png" alt="pic2" class="inline"/></p>
<p>Again let's have a look on the kernel32 imports</p>
<p><img src="Images/pic3.png" alt="pic3" class="inline"/></p>
<p>There's no existence of <code>SetLastError</code> or <code>GetLastError</code> A confirmation that two files will work properly</p>
<p><img src="Images/pic4.png" alt="pic4" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md4"></a>
Impact</h1>
<p>IDA HexRays Decompiler</p>
<p><img src="Images/pic5.png" alt="pic5" class="inline"/></p>
<p>IDA Debugger</p>
<p><img src="Images/pic6.png" alt="pic6" class="inline"/></p>
<p>Ghidra</p>
<p><img src="Images/pic7.png" alt="pic7" class="inline"/></p>
<p>ApiMonitor</p>
<p><img src="Images/pic8.png" alt="pic8" class="inline"/></p>
<p>That's because all of the static analysis tool depend on what is the api name written at IAT which can be manipulated as shown. For ApiMonitor, because of using IAT hooking, the same problem exists.</p>
<p>On the other side, for tools like x64dbg the shown api names will only depend on what is actually called (not what written at the IAT).</p>
<p><img src="Images/pic9.png" alt="pic9" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md5"></a>
Additional</h1>
<ul>
<li>Dumping the obfuscated PE out from memory won't deobfuscate it, because the manipulated IAT will be the same.</li>
<li>The main purpose for this tool is to mess up with the analysis process (make it slower).</li>
<li>One can obfuscate any imported symbol (by name or by ordinal) with another symbol (name or ordinal).</li>
<li>The shellcode is executed as the first tls callback to process the obfuscated symbols needed by the other tls callbacks before the entry point is executed.</li>
<li>The shellcode is shipped as c code, generated when the tool is compiled to facilitate editing it.</li>
<li>The obfuscated symbols names are being resolved by hash not by name directly.</li>
<li>The tool disables the relocations and strips any of the debug symbols.</li>
<li>The tool creates a new rwx section named <code>.cobf</code> for holding the shellcode and the other needed datas.</li>
<li>It can be used multiple times on the same obfuscated PE.</li>
<li>Tested only on Windows 10 x64.</li>
<li>Get source with <code>git clone <a href="https://github.com/d35ha/CallObfuscator">https://github.com/d35ha/CallObfuscator</a></code>.</li>
<li>Download binaries from the <a href="https://github.com/d35ha/CallObfuscator/releases">Release Section</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
TODO</h1>
<ul>
<li>Shellcode obfuscation (probably with <a href="https://github.com/kgretzky/obfusion">obfusion</a>).</li>
<li>Support the delay-loaded symbols.</li>
<li>Minimize the created section size.</li>
<li>Better testing. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
